-- =====================================================
-- Задача: Расчет средней цены товаров с исключением самого дорогого
-- Тема: Оконные функции с FILTER clause для условной агрегации

-- Цель: Проанализировать влияние самого дорогого товара на среднюю цену ассортимента
--        путем сравнения общей средней цены и средней цены без учета максимальной

-- Условия:
-- • Рассчитать среднюю цену всех товаров
-- • Рассчитать среднюю цену без самого дорогого товара  
-- • Округлить результаты до двух знаков после запятой
-- • Отсортировать по убыванию цены для наглядности
-- =====================================================
SELECT 
  product_id, 
  name, 
  price, 
  ROUND(
    AVG(price) OVER(), 
    2
  ) AS avg_price, 
  ROUND(
    AVG(price) FILTER (
      WHERE 
        price < (
          SELECT 
            MAX(price) 
          FROM 
            products
        )
    ) OVER(), 
    2
  ) AS avg_price_filtered 
FROM 
  products 
ORDER BY 
  price DESC, 
  product_id
