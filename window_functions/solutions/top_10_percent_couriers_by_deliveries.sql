-- =====================================================
-- Задача: Выделение топ 10% курьеров по количеству доставок
-- Тема: Оконные функции с ранжированием и процентными расчетами

-- Цель: Идентифицировать лучших 10% курьеров по количеству доставленных заказов
--        для программ мотивации и анализа эффективности

-- Условия:
-- • Ранжировать курьеров по убыванию количества доставок
-- • При равенстве доставок использовать возрастание courier_id
-- • Выбрать топ 10% курьеров от общего количества
-- • Округление количества курьеров вверх для гарантии 10% охвата
-- =====================================================
SELECT 
  courier_id, 
  orders_count, 
  courier_rank 
FROM 
  (
    SELECT 
      courier_id, 
      COUNT(order_id) AS orders_count, 
      RANK() OVER(
        ORDER BY 
          COUNT(order_id) DESC, 
          courier_id ASC
      ) AS courier_rank 
    FROM 
      courier_actions 
    WHERE 
      action = 'deliver_order' 
    GROUP BY 
      courier_id
  ) AS ranked_couriers 
WHERE 
  courier_rank <= (
    SELECT 
      CEIL(
        COUNT(DISTINCT courier_id) * 0.1
      ) 
    FROM 
      courier_actions 
    WHERE 
      action = 'deliver_order'
  ) 
ORDER BY 
  courier_rank

-- Логика решения:
-- 1. ВНУТРЕННИЙ ПОДЗАПРОС: Расчет количества доставок и ранжирование
--    • COUNT(order_id) - подсчет доставленных заказов для каждого курьера
--    • RANK() OVER(ORDER BY COUNT(order_id) DESC, courier_id ASC) - ранжирование
--    • DESC для orders_count - приоритет курьеров с большим количеством доставок
--    • ASC для courier_id - при равенстве доставок приоритет у курьеров с меньшим ID
--    • Фильтрация только доставленных заказов (action = 'deliver_order')
--
-- 2. ПОДЗАПРОС ДЛЯ ОПРЕДЕЛЕНИЯ ГРАНИЦЫ: Расчет 10% от общего числа курьеров
--    • COUNT(DISTINCT courier_id) - общее количество уникальных курьеров
--    * 0.1 - вычисление 10% от общего числа
--    • CEIL() - округление ВВЕРХ для гарантии включения хотя бы 10% курьеров
--    • Важно: CEIL вместо ROUND для избежания потери последних курьеров
--
-- 3. ФИЛЬТРАЦИЯ: Отбор только топ 10% курьеров
--    • WHERE courier_rank <= ... - включение курьеров с рангом до вычисленной границы
--    • Гарантирует, что будут выбраны лучшие 10% курьеров
--
-- 4. СОРТИРОВКА РЕЗУЛЬТАТА: Упорядочивание по рангу
--    • ORDER BY courier_rank - вывод от лучшего к худшему в пределах топа

-- Пример результата:
-- courier_id | orders_count | courier_rank
-- 101        | 245          | 1
-- 205        | 243          | 2
-- 308        | 243          | 3
-- ...        | ...          | ...
-- 753        | 38           | 283