-- =====================================================
-- Задача: Последовательная нумерация заказов для каждого пользователя
-- Тема: Оконные функции с PARTITION BY для сегментированного анализа

-- Цель: Присвоить порядковый номер каждому заказу пользователя 
--        в хронологическом порядке для анализа поведения и активности

-- Условия:
-- • Нумеровать заказы отдельно для каждого пользователя
-- • Учитывать хронологический порядок заказов
-- • Исключить отмененные заказы из подсчета
-- • Ограничить вывод 1000 строками для производительности
-- =====================================================
SELECT 
  user_id, 
  order_id, 
  time, 
  order_number 
FROM 
  (
    SELECT 
      user_id, 
      order_id, 
      time, 
      ROW_NUMBER() OVER(
        PARTITION BY user_id 
        ORDER BY 
          time
      ) AS order_number 
    FROM 
      user_actions 
    WHERE 
      order_id NOT IN (
        SELECT 
          order_id 
        FROM 
          user_actions 
        WHERE 
          action = 'cancel_order'
      )
  ) AS t1 
ORDER BY 
  user_id, 
  order_number 
LIMIT 
  1000
