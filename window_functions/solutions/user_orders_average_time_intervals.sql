-- =====================================================
-- Задача: Расчет среднего времени между заказами пользователей
-- Тема: Функции смещения LAG с арифметикой временных меток

-- Цель: Определить средний интервал в часах между последовательными заказами
--        для пользователей с более чем одним заказом

-- Условия:
-- • Учитывать только пользователей с ≥2 неотмененными заказами
-- • Выразить средний интервал в целых часах
-- • Исключить отмененные заказы из анализа
-- =====================================================
SELECT 
  user_id, 
  AVG(time_diff):: INTEGER AS hours_between_orders 
FROM 
  (
    SELECT 
      user_id, 
      order_id, 
      time, 
      EXTRACT(
        epoch 
        FROM 
          (
            time - lag(time, 1) OVER (
              PARTITION BY user_id 
              ORDER BY 
                time
            )
          )
      )/ 3600 AS time_diff 
    FROM 
      user_actions 
    WHERE 
      order_id NOT IN (
        SELECT 
          order_id 
        FROM 
          user_actions 
        WHERE 
          action = 'cancel_order'
      )
  ) AS t 
WHERE 
  time_diff IS NOT NULL 
GROUP BY 
  user_id 
ORDER BY 
  user_id 
LIMIT 
  1000
-- Логика решения:
-- 1. ВНУТРЕННИЙ ПОДЗАПРОС: Вычисление интервалов в часах
--    • LAG(time, 1) OVER (PARTITION BY user_id ORDER BY time) - время предыдущего заказа
--    • time - LAG(time) - разница между временными метками (интервал)
--    • EXTRACT(epoch FROM ...) - преобразование интервала в секунды
--    • / 3600 - перевод секунд в часы
--    • Для первых заказов time_diff = NULL (нет предыдущего заказа)
--
-- 2. ФИЛЬТРАЦИЯ: Исключение первых заказов
--    • WHERE time_diff IS NOT NULL - удаление записей с NULL
--    • Остаются только интервалы между 2-м и 1-м, 3-м и 2-м заказами и т.д.
--    • Автоматически исключает пользователей с одним заказом
--
-- 3. АГРЕГАЦИЯ: Расчет среднего интервала
--    • GROUP BY user_id - группировка по пользователям
--    • AVG(time_diff) - среднее значение всех интервалов пользователя
--    • ::integer - приведение к целому числу (неявное округление)
--
-- 4. СОРТИРОВКА И ОГРАНИЧЕНИЕ: Формирование результата
--    • ORDER BY user_id - упорядочивание по ID пользователя
--    • LIMIT 1000 - ограничение вывода для больших наборов данных

-- Пример результата:
-- user_id | hours_between_orders
-- 1001    | 36
-- 1002    | 120
-- 1003    | 18
-- 1004    | 72
