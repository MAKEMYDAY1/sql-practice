-- =====================================================
-- Задача: Многомерный анализ распределения пользователей по возрасту и полу
-- Тема: Группировка данных в SQL
-- Цель: Создать детальное распределение пользователей по возрасту и полу

-- Используемые операторы:
-- WHERE - фильтрация NULL значений в датах рождения
-- GROUP BY с несколькими полями - многомерная группировка
-- DATE_PART() с AGE() - точный расчет возраста
-- ORDER BY с приоритетами - комплексная сортировка
-- =====================================================

SELECT 
  sex, 
  DATE_PART(
    'year', 
    AGE(birth_date)
  ):: INTEGER AS age, 
  COUNT(user_id) AS users_count 
FROM 
  users 
WHERE 
  birth_date IS NOT NULL 
GROUP BY 
  sex, 
  DATE_PART(
    'year', 
    AGE(birth_date)
  ):: INTEGER 
ORDER BY 
  DATE_PART(
    'year', 
    AGE(birth_date)
  ):: INTEGER, 
  sex

-- Логика решения:
-- 1. WHERE birth_date IS NOT NULL - исключает пользователей с неизвестной датой рождения
--    • Критично для точности демографического анализа
-- 2. DATE_PART('year', AGE(birth_date))::INTEGER - вычисляет возраст в полных годах
-- 3. GROUP BY sex, age - создает уникальные комбинации пол-возраст
--    • Например: (female, 25), (male, 25), (female, 26), etc.
-- 4. COUNT(user_id) - подсчитывает пользователей в каждой половозрастной группе
-- 5. ORDER BY age, sex - сортирует сначала по возрасту, затем по полу

-- Пример результата:
-- sex    | age | users_count
-- female | 18  | 85
-- male   | 18  | 71
-- female | 19  | 120
-- male   | 19  | 114
-- ...    | ... | ...