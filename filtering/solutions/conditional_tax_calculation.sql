-- =====================================================
-- Задача: Расчет НДС с разными ставками для категорий товаров
-- Цель: Рассчитать НДС по ставке 10% для конкретного списка продуктов и 20% для остальных товаров

-- Используемые техники:
-- CASE WHEN с сложными условиями
-- IN со списком значений
-- Финансовые расчеты с округлением
-- =====================================================

SELECT 
  product_id, 
  name, 
  price, 
  CASE WHEN name IN (
    'сахар', 'сухарики', 
    'сушки', 'семечки', 
    'масло льняное', 'виноград', 
    'масло оливковое', 
    'арбуз', 'батон', 'йогурт', 
    'сливки', 'гречка', 
    'овсянка', 'макароны', 
    'баранина', 'апельсины', 
    'бублики', 'хлеб', 'горох', 
    'сметана', 'рыба копченая', 
    'мука', 'шпроты', 'сосиски', 
    'свинина', 'рис', 'масло кунжутное', 
    'сгущенка', 'ананас', 
    'говядина', 'соль', 
    'рыба вяленая', 'масло подсолнечное', 
    'яблоки', 'груши', 'лепешка', 
    'молоко', 'курица', 
    'лаваш', 'вафли', 'мандарины'
  ) THEN ROUND(price / 110 * 10, 2) ELSE ROUND(price / 120 * 20, 2) END AS tax, 
  CASE WHEN name IN (
    'сахар', 'сухарики', 
    'сушки', 'семечки', 
    'масло льняное', 'виноград', 
    'масло оливковое', 
    'арбуз', 'батон', 'йогурт', 
    'сливки', 'гречка', 
    'овсянка', 'макароны', 
    'баранина', 'апельсины', 
    'бублики', 'хлеб', 'горох', 
    'сметана', 'рыба копченая', 
    'мука', 'шпроты', 'сосиски', 
    'свинина', 'рис', 'масло кунжутное', 
    'сгущенка', 'ананас', 
    'говядина', 'соль', 
    'рыба вяленая', 'масло подсолнечное', 
    'яблоки', 'груши', 'лепешка', 
    'молоко', 'курица', 
    'лаваш', 'вафли', 'мандарины'
  ) THEN ROUND(
    price - (price / 110 * 10), 
    2
  ) ELSE ROUND(
    price - (price / 120 * 20), 
    2
  ) END AS price_before_tax 
FROM 
  products 
ORDER BY 
  price_before_tax DESC, 
  product_id

-- Логика решения:
-- 1. Определяем товары с пониженной ставкой НДС 10% через список IN
--    • 41 товар из категории продуктов питания
--    • Остальные товары облагаются стандартной ставкой 20%
-- 2. Расчет суммы НДС для ставки 10%:
--    • НДС = price / 110 * 10 (цена включает 110% = 100% стоимости + 10% НДС)
--    • Формула: Сумма_НДС = Цена_с_НДС × (Ставка_НДС / (100 + Ставка_НДС))
-- 3. Расчет суммы НДС для ставки 20%:
--    • НДС = price / 120 * 20 (цена включает 120% = 100% стоимости + 20% НДС)
-- 4. Расчет цены без учета НДС:
--    • Цена_без_НДС = Цена_с_НДС - Сумма_НДС
-- 5. Округление до 2 знаков для финансовой точности
-- 6. Сортировка по убыванию цены без НДС, затем по возрастанию ID

-- Пример результата:
-- product_id | name           | price  | tax   | price_before_tax | tax_rate
-- 105        | iPhone 15 Pro  | 1200.00| 200.00| 1000.00          | 20%
-- 102        | MacBook Pro    | 1440.00| 240.00| 1200.00          | 20%
-- 115        | сахар          | 110.00 | 10.00 | 100.00           | 10%
-- 123        | молоко         | 88.00  | 8.00  | 80.00            | 10%
-- 147        | хлеб           | 55.00  | 5.00  | 50.00            | 10%
-- 152        | йогурт         | 66.00  | 6.00  | 60.00            | 10%