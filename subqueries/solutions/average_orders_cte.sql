-- =====================================================
-- Задача: Расчет среднего количества заказов на пользователя с использованием CTE
-- Тема: Common Table Expressions (WITH clause)
-- Цель: Рассчитать среднее арифметическое количество заказов по всем пользователям с использованием CTE

-- Используемые операторы:
-- WITH clause (CTE) - создание именованного временного результата запроса
-- COUNT() - подсчет заказов для каждого пользователя
-- AVG() - расчет среднего значения по всем пользователям
-- ROUND() - округление результата до двух знаков после запятой
-- GROUP BY - группировка по пользователям в CTE
-- =====================================================

WITH subquerry_1 AS (
  SELECT 
    user_id, 
    COUNT(order_id) AS order_count 
  FROM 
    user_actions 
  WHERE 
    action = 'create_order' 
  GROUP BY 
    user_id
) 
SELECT 
  ROUND(
    AVG(order_count), 
    2
  ) AS orders_avg 
FROM 
  subquerry_1
