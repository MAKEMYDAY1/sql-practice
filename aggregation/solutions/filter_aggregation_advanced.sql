-- =====================================================
-- Задача: Анализ пользователей без отмененных заказов
-- Тема: Агрегация данных в SQL
-- Цель: Найти количество пользователей, которые никогда не отменяли свои заказы

-- Используемые техники:
-- COUNT(DISTINCT) с FILTER - условная агрегация
-- =====================================================

SELECT 
  COUNT(DISTINCT user_id) - (
    COUNT(DISTINCT user_id) FILTER (
      WHERE 
        action = 'cancel_order'
    )
  ) AS users_count 
FROM 
  user_actions

-- Логика решения:
-- 1. COUNT(DISTINCT user_id) - общее количество уникальных пользователей
-- 2. COUNT(DISTINCT user_id) FILTER (WHERE action = 'cancel_order') - количество пользователей, которые хотя бы раз отменяли заказ
-- 3. Разность: общие пользователи - пользователи с отменами = пользователи без отмен


-- Пример результата:
-- users_count
-- 18641	