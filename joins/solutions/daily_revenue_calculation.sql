-- =====================================================
-- Задача: Расчет ежедневной выручки сервиса
-- Тема: Агрегация с CROSS JOIN UNNEST для анализа выручки

-- Цель: Посчитать ежедневную выручку от неотмененных заказов
--        Выручка = сумма стоимостей всех товаров в реализованных заказах

-- Используемые операторы:
-- CROSS JOIN UNNEST - преобразование массивов товаров в реляционный формат
-- LEFT JOIN - объединение таблиц с сохранением всех заказов
-- SUM - агрегация для подсчёта общей выручки
-- GROUP BY - группировка по датам для ежедневной статистики
-- Подзапрос WHERE - фильтрация неотмененных заказов
-- =====================================================
SELECT 
  DATE(ua.time) AS date, 
  SUM(p.price) AS revenue 
FROM 
  user_actions AS ua 
  LEFT JOIN orders AS o ON ua.order_id = o.order_id CROSS 
  JOIN UNNEST(o.product_ids) AS product_id_2 
  LEFT JOIN products AS p ON product_id_2 = p.product_id 
WHERE 
  ua.order_id NOT IN (
    SELECT 
      order_id 
    FROM 
      user_actions 
    WHERE 
      action = 'cancel_order'
  ) 
GROUP BY 
  DATE(ua.time) 
ORDER BY 
  date

-- Логика решения:
-- 1. ОСНОВНЫЕ ТАБЛИЦЫ: user_actions и orders
--    • LEFT JOIN по order_id - связываем действия пользователей с заказами
--    • Сохраняем все заказы, даже если есть проблемы в данных
--
-- 2. CROSS JOIN UNNEST: Денормализация массивов товаров
--    • UNNEST(o.product_ids) - преобразует массивы product_ids в отдельные строки
--    • Каждый товар в заказе становится отдельной записью
--    • AS product_id_2 - создает временный столбец с ID товаров
--
-- 3. LEFT JOIN products: Добавление информации о ценах
--    • ON product_id_2 = p.product_id - соединение по идентификатору товара
--    • LEFT JOIN гарантирует учет всех товаров из заказов
--    • Если товара нет в справочнике - price будет NULL (игнорируется в SUM)
--
-- 4. ФИЛЬТРАЦИЯ: Только неотмененные заказы
--    • Подзапрос WHERE исключает отмененные заказы
--    • NOT IN (SELECT order_id FROM user_actions WHERE action = 'cancel_order')
--    • Обеспечивает корректность расчета выручки (только реализованные товары)
--
-- 5. АГРЕГАЦИЯ: Группировка по датам и суммирование выручки
--    • GROUP BY DATE(ua.time) - группировка по дням
--    • SUM(p.price) - суммирование цен всех товаров за день
--    • Формирует итоговую ежедневную выручку

-- Пример результата:
-- date       | revenue
-- 2022-01-01 | 12580.50
-- 2022-01-02 | 18420.75
-- 2022-01-03 | 15230.25
-- 2022-01-04 | 19840.60
