-- =====================================================
-- Задача: Трансформация ID товаров в наименования в заказах
-- Тема: Обратимые преобразования массивов с UNNEST и ARRAY_AGG

-- Цель: Заменить массивы с ID товаров в заказах на массивы с наименованиями товаров
--        с сохранением структуры данных и порядка элементов

-- Условия:
-- • Преобразовать product_ids (массив ID) в product_names (массив наименований)
-- • Сохранить исходную структуру заказов
-- • Использовать таблицу products для получения наименований
-- • Ограничить вывод 1000 строками для производительности
-- =====================================================
SELECT 
  order_id, 
  array_agg(name) AS product_names 
FROM 
  (
    SELECT 
      order_id, 
      UNNEST(product_ids) AS product_id 
    FROM 
      orders
  ) t1 
  LEFT JOIN products USING (product_id) 
GROUP BY 
  t1.order_id 
LIMIT 
  1000
