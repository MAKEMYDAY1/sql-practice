-- =====================================================
-- Задача: Анализ коэффициента отмен заказов по полу пользователей
-- Тема: Условная агрегация с FILTER и обработка отсутствующих данных

-- Цель: Рассчитать средний коэффициент отмен заказов (cancel_rate) 
--        для каждого пола пользователей, включая пользователей с неизвестным полом

-- Условия:
-- • Учесть всех пользователей из user_actions (даже без данных в таблице users)
-- • Для пользователей с неизвестным полом использовать значение 'unknown'
-- • cancel_rate = количество отмен / количество созданных заказов
-- • Округлить результат до трёх знаков после запятой
-- =====================================================
SELECT 
  COALESCE(u.sex, 'unknown') as sex, 
  ROUND(
    AVG(ua.cancel_rate), 
    3
  ) as avg_cancel_rate 
FROM 
  (
    SELECT 
      user_id, 
      COUNT(order_id) FILTER (
        WHERE 
          action = 'cancel_order'
      ):: decimal / NULLIF(
        COUNT(order_id) FILTER (
          WHERE 
            action = 'create_order'
        ), 
        0
      ) as cancel_rate 
    FROM 
      user_actions 
    GROUP BY 
      user_id
  ) ua 
  LEFT JOIN users u USING(user_id) 
GROUP BY 
  COALESCE(u.sex, 'unknown') 
ORDER BY 
  sex

-- Логика решения:
-- 1. ВНУТРЕННИЙ ПОДЗАПРОС: Расчет cancel_rate на уровне пользователей
--    • FILTER (WHERE action = 'cancel_order') - подсчет отмененных заказов
--    • FILTER (WHERE action = 'create_order') - подсчет созданных заказов
--    • NULLIF(..., 0) - защита от деления на ноль (если нет созданных заказов)
--    • ::decimal - приведение к decimal для точного деления
--    • GROUP BY user_id - агрегация на уровне отдельных пользователей
--
-- 2. LEFT JOIN users: Добавление информации о поле
--    • LEFT JOIN гарантирует сохранение всех пользователей из user_actions
--    • USING(user_id) - упрощенный синтаксис при совпадающих именах столбцов
--    • Пользователи без записи в таблице users получат NULL в поле sex
--
-- 3. COALESCE для обработки отсутствующих данных:
--    • COALESCE(u.sex, 'unknown') - замена NULL на 'unknown'
--    • Обеспечивает корректную группировку для всех категорий пользователей
--
-- 4. ФИНАЛЬНАЯ АГРЕГАЦИЯ: Расчет среднего значения по полу
--    • AVG(ua.cancel_rate) - средний коэффициент отмен для каждой группы
--    • ROUND(..., 3) - округление до трёх знаков после запятой
--    • GROUP BY COALESCE(u.sex, 'unknown') - группировка по полу с учетом unknown
--    • ORDER BY sex - сортировка по полу для упорядоченного результата

-- Пример результата:
-- sex     | avg_cancel_rate
-- --------|-----------------
-- female  | 0.157
-- male    | 0.142
-- unknown | 0.165