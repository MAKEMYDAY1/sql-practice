-- =====================================================
-- Задача: Детальный анализ заказов с ценами на товары
-- Тема: UNNEST массивов с последующим LEFT JOIN

-- Цель: Создать детализированное представление заказов с информацией о ценах товаров

-- Используемые операторы:
-- UNNEST - преобразование массивов в отдельные строки
-- LEFT JOIN - объединение с сохранением всех товаров из заказов
-- Подзапрос в FROM - подготовка денормализованных данных
-- =====================================================
SELECT 
  o.order_id, 
  o.product_id, 
  p.price 
FROM 
  (
    SELECT 
      order_id, 
      UNNEST(product_ids) AS product_id 
    FROM 
      orders
  ) AS o 
  LEFT JOIN products AS p ON o.product_id = p.product_id 
ORDER BY 
  o.order_id, 
  p.product_id 
LIMIT 
  1000
